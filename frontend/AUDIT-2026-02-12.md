# Audit Approfondi — Un Bateau a Paris (Frontend)

**Date initiale** : 12 fevrier 2026 (commit `72536a4`)
**Mise a jour** : 13 fevrier 2026 (Sprint 5 + corrections hautes/moyennes priorites)
**Branche** : `main`
**Auditeur** : Claude Code

---

## Sommaire

1. [Resume executif](#1-resume-executif)
2. [Historique des corrections](#2-historique-des-corrections)
3. [Etat actuel detaille](#3-etat-actuel-detaille)
4. [Points positifs](#4-points-positifs)
5. [Problemes restants](#5-problemes-restants)
6. [Metriques comparees](#6-metriques-comparees)

---

## 1. Resume executif

| Categorie | 12 fev (initial) | 13 fev (actuel) |
|-----------|------------------|-----------------|
| Build production | OK | OK |
| ESLint | FAIL (143 erreurs) | OK (~0 erreur custom) |
| Tests unitaires | 34/35 (1 FAIL) | **65/65 OK** |
| Tests E2E | 28/28 OK | 28/28 OK |
| SEO (canonical/hreflang) | Absent | **Complet (10 pages)** |
| SEO (JSON-LD) | LocalBusiness seul | **LocalBusiness + FAQPage + Offers + Article** |
| Accessibilite WCAG | Partiel | **Substantiel** |
| Headers securite | Absents | **5 headers (dont CSP)** |
| Error boundaries | Absents | **En place** |
| Vulnerabilites npm | 0 | 0 |
| Vecteurs XSS | 1 (non sanitise) | **0 (DOMPurify)** |
| Images `next/image` | 0/8+ | **8+/8+** |

**Score global : 9/10** (etait 6/10) — SEO, accessibilite, securite, images et performance significativement ameliores.

---

## 2. Historique des corrections

### Sprint 1 (commit `b683ac3`) — Corrections critiques

| # | Action | Statut |
|---|--------|--------|
| C1 | Echappement apostrophes JSX (~100 erreurs) | **FAIT** |
| H1 | `<a>` → `<Link>` navigation interne | **FAIT** |
| H5 | Fix test CookieBanner (alias vitest) | **FAIT** |
| L1 | Suppression variables non utilisees | **FAIT** |
| L3 | Logger structure (`src/lib/logger.ts`) | **FAIT** |
| — | btn-gold text-white fix | **FAIT** |

### Sprint 2-3 (commit `fad872d`) — i18n & UX

| # | Action | Statut |
|---|--------|--------|
| — | Loading message reservation | **FAIT** |
| — | WordPress preconnect | **FAIT** |
| — | Traductions i18n supplementaires | **FAIT** |

### Sprint 4 (commit `f55d016`) — SEO & Blog EN

| # | Action | Statut |
|---|--------|--------|
| — | Blog bilingue FR/EN | **FAIT** |
| — | Article CTA | **FAIT** |
| — | Hreflang initial (layout) | **FAIT** |
| 4.4 | Logger structure en production | **FAIT** |

### Sprint 5 (commit `e21b977`) — Audit approfondi

| # | Action | Statut |
|---|--------|--------|
| **SEO** | Canonical par page (10 pages) | **FAIT** |
| **SEO** | Hreflang alternates + x-default par page | **FAIT** |
| **SEO** | og:locale dynamique (fr_FR/en_US) | **FAIT** |
| **SEO** | `<html lang>` dynamique via `getLocale()` | **FAIT** |
| **SEO** | Helper `src/lib/metadata.ts` | **FAIT** |
| **A11y** | Skip-to-content link | **FAIT** |
| **A11y** | `aria-label` sur `<nav>` | **FAIT** |
| **A11y** | `aria-expanded` + `aria-controls` menu mobile | **FAIT** |
| **A11y** | `htmlFor`/`id` formulaire contact (4 champs) | **FAIT** |
| **A11y** | `aria-required` champs obligatoires | **FAIT** |
| **A11y** | `role="dialog"` + `aria-modal` + `aria-labelledby` CookieModal | **FAIT** |
| **A11y** | `id="main"` sur toutes les vues (9 fichiers) | **FAIT** |
| **Securite** | X-Content-Type-Options: nosniff | **FAIT** |
| **Securite** | X-Frame-Options: DENY | **FAIT** |
| **Securite** | Referrer-Policy: strict-origin-when-cross-origin | **FAIT** |
| **Securite** | Permissions-Policy (camera, mic, geo, cohort) | **FAIT** |
| **Securite** | `poweredByHeader: false` | **FAIT** |
| **Perf** | AVIF image format active | **FAIT** |
| **Erreurs** | `error.tsx` (error boundary locale) | **FAIT** |
| **Erreurs** | `global-error.tsx` (error boundary racine) | **FAIT** |
| **UX** | Iframe reservation 800px → 1200px | **FAIT** |
| **Monitoring** | Vercel Speed Insights | **FAIT** |
| **i18n** | Cle `mainNav` (fr/en) | **FAIT** |

### Sprint 6 — Corrections haute et moyenne priorite

| # | Action | Statut |
|---|--------|--------|
| **R1** | Migration `<img>` → `next/image` (6 composants) | **FAIT** |
| **R2** | DOMPurify sur `dangerouslySetInnerHTML` | **DEJA FAIT** (ArticleDetail.tsx) |
| **R3** | Content-Security-Policy header (12 directives) | **FAIT** |
| **R3** | Instagram CDN dans `remotePatterns` | **FAIT** |
| **R4** | Code splitting lightbox (`next/dynamic`, ssr: false) | **FAIT** |
| **R5** | `key={index}` listes dynamiques | **DEJA RESOLU** (toutes les listes ont des cles uniques) |
| **R6** | Fix `useEffect` deps CookieModal | **FAIT** |
| **R7** | JSON-LD FAQPage (10 Q&A) | **FAIT** |
| **R8** | Aria-labels carousel/filtres | **DEJA RESOLU** (TestimonialsVariants, BoatImageSlideshow complets) |

**Fichiers modifies (Sprint 6)** :
- `next.config.ts` — CSP header + Instagram remotePatterns
- `src/components/Boat.tsx` — `<img>` → `<Image fill>`
- `src/components/CallToAction.tsx` — `<img>` → `<Image fill>`
- `src/components/Offers.tsx` — `<img>` → `<Image fill>`
- `src/components/Testimonials.tsx` — `<img>` → `<Image width/height>`
- `src/views/Galerie.tsx` — Instagram `<img>` → `<Image>` + dynamic import lightbox
- `src/views/Actualites.tsx` — Instagram `<img>` → `<Image>`
- `src/components/GalleryLightbox.tsx` — **NOUVEAU** (wrapper lightbox pour code splitting)
- `src/components/CookieModal.tsx` — Fix useEffect deps `[open]`
- `src/app/[locale]/faq/page.tsx` — JSON-LD FAQPage

---

## 3. Etat actuel detaille

### 3.1 Build & TypeScript

| Metrique | Resultat |
|----------|----------|
| `npm run build` | OK (Turbopack) |
| `tsc --noEmit` | 0 erreur |
| Pages statiques | 7 |
| Routes dynamiques | 10 (`/[locale]/*`) |
| API routes | 2 (`/api/contact`, `/api/instagram`) |
| Next.js | 16.1.6 |
| TypeScript | 5.9.3, strict mode |

**Warning** : middleware.ts deprecie → migrer vers `proxy` (Next.js 16). Reporte : next-intl n'a pas encore publie d'API compatible.

### 3.2 ESLint

| Avant | Apres |
|-------|-------|
| 143 erreurs, 30 warnings | ~0 erreur custom (restantes = shadcn/ui genere) |

### 3.3 Tests

| Suite | Avant | Apres |
|-------|-------|-------|
| Tests unitaires (Vitest) | 34/35 (1 FAIL) | **65/65 OK** |
| Tests E2E (Playwright) | 28/28 | 28/28 |
| Couverture composants | ~7% | ~15% |

### 3.4 SEO

| Element | Avant | Apres |
|---------|-------|-------|
| Canonical URLs | Toutes pointaient vers `/` | **Unique par page** (10 pages) |
| Hreflang alternates | Heritage layout (incorrectes) | **Par page avec x-default** |
| og:locale | Hardcode `fr_FR` | **Dynamique fr_FR/en_US** |
| `<html lang>` | Hardcode `fr` | **Dynamique via getLocale()** |
| JSON-LD LocalBusiness | En place | En place |
| JSON-LD FAQPage | Absent | **En place (10 Q&A)** |
| JSON-LD offres | En place (Croisiere) | En place |
| JSON-LD Article | En place (ArticleDetail) | En place |
| Sitemap | En place (`sitemap.ts`) | En place |

### 3.5 Accessibilite

| Element | Avant | Apres |
|---------|-------|-------|
| Skip-to-content | Absent | **En place** |
| `<html lang>` dynamique | Non | **Oui** |
| Nav `aria-label` | Absent | **En place** |
| Menu mobile `aria-expanded`/`aria-controls` | Absent | **En place** |
| Labels formulaire (`htmlFor`/`id`) | Absents | **En place** (4 champs) |
| `aria-required` champs obligatoires | Absent | **En place** |
| CookieModal `role="dialog"` | Absent | **En place** |
| CookieModal `aria-modal`/`aria-labelledby` | Absent | **En place** |
| `id="main"` sur `<main>` | Absent | **En place** (9 vues) |
| Aria-labels carousel/filtres | Partiels | **Complets** |

### 3.6 Securite

| Header/Protection | Avant | Apres |
|-------------------|-------|-------|
| X-Content-Type-Options | Absent | **nosniff** |
| X-Frame-Options | Absent | **DENY** |
| Referrer-Policy | Absent | **strict-origin-when-cross-origin** |
| Permissions-Policy | Absent | **camera=(), microphone=(), geolocation=(), interest-cohort=()** |
| Content-Security-Policy | Absent | **12 directives (GA4, fonts, Instagram, WP)** |
| X-Powered-By | Expose (Next.js) | **Supprime** |
| XSS `dangerouslySetInnerHTML` | 1 occurrence non sanitisee | **Sanitise (DOMPurify)** |
| Error boundaries | Absents | **En place** (`error.tsx` + `global-error.tsx`) |
| `npm audit` | 0 vulnerabilite | 0 vulnerabilite |
| Rate limiting API | En place | En place |
| Honeypot anti-spam | En place | En place |
| Instagram token | Expire 2026-04-04 | Expire 2026-04-04 (50 jours) |

### 3.7 Performance

| Element | Avant | Apres |
|---------|-------|-------|
| Image format AVIF | Non | **Active** |
| Speed Insights | Non | **Active** (Vercel) |
| `<img>` → `next/image` | 8+ occurrences `<img>` | **Tout migre vers `next/image`** |
| Code splitting (`next/dynamic`) | Absent | **Lightbox lazy-loaded** (~50 KB economises) |
| React.memo composants lourds | Absent | Absent (impact mineur) |

### 3.8 Code Quality

| Element | Avant | Apres |
|---------|-------|-------|
| Logger structure | Absent | **En place** (`src/lib/logger.ts`) |
| Error boundaries | Absents | **En place** |
| Metadata helper | Absent | **En place** (`src/lib/metadata.ts`) |
| `key={index}` listes dynamiques | 4 occurrences | **Toutes resolues** (cles uniques partout) |
| setState dans useEffect | 2 occurrences | **1 occurrence** (CookieProvider legitime — init localStorage) |
| Composants monolithiques >250 lignes | 4 | 4 (reporte — pas d'impact utilisateur) |

---

## 4. Points positifs

| Aspect | Detail |
|--------|--------|
| Build rapide | Turbopack, 0 erreur TypeScript |
| 0 vulnerabilite npm | Dependances saines |
| Tests solides | 65 unitaires + 28 E2E, axe-core WCAG inclus |
| TypeScript strict | 0 erreur de compilation |
| RGPD conforme | GA4 Consent Mode v2, cookie banner, defaults "denied" EU |
| Anti-spam | Rate limiting 3 req/min + honeypot + escapeHtml |
| SEO complet | Canonical + hreflang + og:locale sur 10 pages + JSON-LD (4 schemas) |
| i18n bilingue | next-intl FR/EN, 230+ cles, 16 namespaces, blog bilingue |
| Accessibilite substantielle | Skip-to-content, aria-labels complets, dialog modal, labels formulaire |
| Headers securite | **5 headers** dont CSP + poweredByHeader desactive |
| Securite XSS | DOMPurify sur tout contenu HTML dynamique |
| Images optimisees | Tout migre vers `next/image` (AVIF/WebP, lazy loading, srcset) |
| Code splitting | Lightbox galerie lazy-loaded (next/dynamic) |
| Error handling | Error boundaries locale + global |
| Monitoring | Vercel Speed Insights actif |
| Design system coherent | Tailwind v4 avec tokens `@theme inline` |
| Animations soignees | Framer Motion sur tous les composants |
| Logger structure | JSON en prod, lisible en dev |

---

## 5. Problemes restants

### BASSE priorite

| # | Probleme | Localisation | Impact |
|---|----------|-------------|--------|
| R9 | **Middleware deprecie** → migrer vers proxy | middleware.ts | Deprecation warning (next-intl pas encore compatible) |
| R10 | **Composants monolithiques** (>250 lignes) | Croisiere.tsx, Actualites.tsx | Maintenance (pas d'impact utilisateur) |
| R11 | Couverture tests composants ~15% | src/__tests__/ | Regressions non detectees |
| R12 | Composants shadcn avec @ts-nocheck | chart.tsx, resizable.tsx | Perte type safety (code genere) |
| R13 | Interface useInstagramFeed trompeuse | hooks/useInstagramFeed.ts | API confuse |

Toutes les priorites hautes et moyennes sont resolues.

---

## 6. Metriques comparees

| Metrique | 12 fev (initial) | 13 fev (actuel) | Cible finale |
|----------|------------------|-----------------|--------------|
| Erreurs ESLint | 143 | ~0 (custom) | 0 |
| Tests unitaires | 34/35 | **65/65** | 80+ |
| Tests E2E | 28/28 | 28/28 | 28/28 |
| Couverture composants | 7% | ~15% | 25%+ |
| Vulnerabilites npm | 0 | 0 | 0 |
| SEO canonical/hreflang | 0/10 pages | **10/10 pages** | 10/10 |
| JSON-LD schemas | 1 | **4** | 4 |
| Headers securite | 0/5 | **5/5** | 5/5 |
| Vecteurs XSS | 1 | **0** | 0 |
| Error boundaries | 0 | **2** | 2 |
| Images `next/image` | 0/8+ | **8+/8+** | 8+/8+ |
| Code splitting | 0 | **1** (lightbox) | 1+ |
| `<html lang>` dynamique | Non | **Oui** | Oui |
| WCAG skip-to-content | Non | **Oui** | Oui |
| WCAG form labels | Non | **Oui** | Oui |
| WCAG dialog modal | Non | **Oui** | Oui |
| WCAG aria-labels | Partiels | **Complets** | Complets |
| Score global | **6/10** | **9/10** | 9.5/10 |

---

*Rapport initial : 12 fevrier 2026 — Derniere mise a jour : 13 fevrier 2026 — Claude Code*
