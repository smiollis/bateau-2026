name: Refresh Instagram Token & Import

on:
  schedule:
    - cron: '0 8 1,15 * *'  # 1st and 15th of each month at 08:00 UTC
  workflow_dispatch:

permissions:
  contents: write

concurrency:
  group: ${{ github.workflow }}
  cancel-in-progress: false

jobs:
  refresh-and-import:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    defaults:
      run:
        working-directory: frontend
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: frontend/package-lock.json

      - run: npm ci

      - name: Refresh Instagram long-lived token
        id: refresh
        run: |
          RESPONSE=$(curl -s -H "Authorization: Bearer ${{ secrets.INSTAGRAM_ACCESS_TOKEN }}" "https://graph.instagram.com/refresh_access_token?grant_type=ig_refresh_token")
          NEW_TOKEN=$(echo "$RESPONSE" | jq -r '.access_token // empty')
          if [ -z "$NEW_TOKEN" ]; then
            echo "::error::Failed to refresh Instagram token"
            echo "Response: $(echo "$RESPONSE" | jq -r '.error.message // "Unknown error"')"
            exit 1
          fi
          EXPIRES=$(echo "$RESPONSE" | jq -r '.expires_in')
          echo "::add-mask::$NEW_TOKEN"
          echo "new_token=$NEW_TOKEN" >> "$GITHUB_OUTPUT"
          echo "Token refreshed â€” expires in $((EXPIRES / 86400)) days"

      - name: Update GitHub secret via gh CLI
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          cd ..
          echo "${{ steps.refresh.outputs.new_token }}" | gh secret set INSTAGRAM_ACCESS_TOKEN

      - name: Import Instagram posts
        run: npm run import:instagram
        env:
          INSTAGRAM_ACCESS_TOKEN: ${{ steps.refresh.outputs.new_token }}

      - name: Commit and push if changed
        run: |
          cd ..
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add frontend/src/data/instagram.json frontend/public/images/instagram/
          git diff --staged --quiet || git commit -m "chore: refresh Instagram token + import $(date -u +%Y-%m-%d)"
          for i in 1 2 3; do
            git pull --rebase origin main && git push && break
            echo "Push attempt $i failed, retrying in 5s..."
            sleep 5
          done
